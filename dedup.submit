#!/bin/bash

#PBS -S /bin/bash
#PBS -N Argonne_TPC_DEDUP
#PBS -m n
#PBS -l walltime=10:00:00
#PBS -l select=1:ncpus=32:ngpus=4
#PBS -o /eagle/argonne_tpc/yadunand/$PBS_JOBNAME.stdout
#PBS -e /eagle/argonne_tpc/yadunand/$PBS_JOBNAME.stderr
#PBS -l filesystems=home:grand:eagle
#PBS -A argonne_tpc
#PBS -q preemptable

export JOBNAME="parsl.GlobusComputeEngine.block-9.1701979292.7644014"
set -e
source ~/setup_agpt_env.sh

cd /lus/eagle/projects/argonne_tpc/yadunand/

rm -Rf /dev/shm/index
# TODO:1  Update this to match the latest index before runs
# cp -R /lus/eagle/projects/argonne_tpc/yadunand/index.PMC-OA /dev/shm/index
cp -R /lus/eagle/projects/argonne_tpc/yadunand/index_combined_8/ /dev/shm/index


old_datasources=(
    /lus/eagle/projects/argonne_tpc/hippekp/agpt-data/Bioarxiv.nougat/parsed_pdfs
    /lus/eagle/projects/argonne_tpc/hippekp/agpt-data/Medrxiv.nougat/parsed_pdfs
    /lus/eagle/projects/argonne_tpc/hippekp/agpt-data/NIH_LitArch.nougat/parsed_pdfs
    /lus/eagle/projects/argonne_tpc/hippekp/agpt-data/OSTI.nougat/parsed_pdfs
    /lus/eagle/projects/argonne_tpc/hippekp/agpt-data/PMC-OA.nougat/parsed_pdfs
)

# TODO:2 Update this block to match the new jsonl dirs to index
datasources=(
    /lus/eagle/projects/argonne_tpc/hippekp/agpt-data/ASM.pymupdf/parsed_pdfs    
)


for datasource in ${datasources[@]}
do
    echo "Datasource : $datasource"
    sourcename=$(basename $(dirname $datasource) | sed 's/.pymupdf//' )
    python -m deduplication --multi \
	   --name $sourcename \
	   --input $datasource \
	   --minhash-dir /lus/eagle/projects/argonne_tpc/yadunand/minhashes/$sourcename \
	   --save-dir /dev/shm/index \
	   --output-file /lus/eagle/projects/argonne_tpc/yadunand/$sourcename.dupes.csv \
	   --num $(( 5 * 10**8 ))
    echo "Copying index to /lus/eagle/projects/argonne_tpc/yadunand/index.$sourcename"
    cp -R /dev/shm/index /lus/eagle/projects/argonne_tpc/yadunand/index.$sourcename
done


